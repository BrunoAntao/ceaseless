(()=>{"use strict";class t{constructor(e=0){this.value=e instanceof t?e.valueOf():e}valueOf(){return this.value}toDegrees(){return this.value*(180/Math.PI)}setDegrees(t){return this.value=t*Math.PI/180,this.value}}class e{constructor(t=0,e=0){this.x=t,this.y=e}static sum(t=new e,s=new e){return new e(t.x+s.x,t.y+s.y)}clone(){return new e(this.x,this.y)}angleBetween(s=new e){return new t(Math.atan2(s.y-this.y,s.x-this.x))}rotate(s=new t,i=new e){const n=Math.cos(s),o=Math.sin(s),h=this.x,r=this.y;this.x=(h-i.x)*n-(r-i.y)*o+i.x,this.y=(h-i.x)*o+(r-i.y)*n+i.y}rotateTo(s=new t,i=new e){const n=this.angleBetween(i);s-n!=Number.EPSILON&&this.rotate(s-n,i)}}class s{constructor(t){this.options=Object.assign({width:800,height:600,backgroundColor:"rgba(0,0,0,0)",container:document.body},t),this.canvas=document.createElement("canvas"),this.canvas.width=this.options.width,this.canvas.height=this.options.height,this.ctx=this.canvas.getContext("2d"),this.options.container.append(this.canvas),this.objects=[],this.Modules={},this.lastCalledTime,this.lastTimestamp,this.fps,this.ctx.font="20px Arial",this.textMetrics=this.ctx.measureText(this.fps),requestAnimationFrame((()=>{this.render()}))}useModule(t){return this.Modules[t.name]=t,t.register(this),this.Modules[t.name]}renderFPS(){if(!this.lastCalledTime)return this.lastTimestamp=performance.now(),this.lastCalledTime=performance.now(),void(this.fps=0);let t=(performance.now()-this.lastCalledTime)/1e3;this.lastCalledTime=performance.now(),performance.now()-this.lastTimestamp>1e3&&(this.lastTimestamp=performance.now(),this.fps="FPS: "+Math.floor(1/t))}update(){}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=this.options.backgroundColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.fillText(this.fps,8,8+this.textMetrics.actualBoundingBoxAscent),this.update();for(const t of this.objects)t.update&&t.update();const t=Object.values(this.Modules);for(const e of t)e.update();for(const t of this.objects)t.cull()||t.render();for(const e of t)e.render();this.renderFPS(),requestAnimationFrame((()=>{this.render()}))}}const i=(t,e)=>{t.ctx.strokeStyle="#ff00ff",t.ctx.beginPath();const s=e.vecs[0];t.ctx.moveTo(s.x,s.y);for(let s=1;s<e.vecs.length;s++){const i=e.vecs[s];t.ctx.lineTo(i.x,i.y)}t.ctx.closePath(),t.ctx.stroke()};class n{constructor(t,e={}){this.name=t,this.options=e}update(){}render(){}register(t){this.scene=t,console.log(`Module ${this.name} loaded.`)}}class o extends n{constructor(){super("AssetLoader"),this.assets={}}load(t,e){this.assets[t]=e,e.then((e=>{this.assets[t]=e}))}loadSprite(t,e,s,i){this.load(t,new Promise((n=>{let o=new Image;o.onload=()=>{n({key:t,image:o,path:e,frameWidth:s,frameHeight:i})},o.src=e})))}getAsset(t){return this.assets[t]}loaded(){return Promise.all(Object.values(this.assets))}}class h extends n{constructor(){super("InputHandler"),this.keys={},this.mouse={x:0,y:0,left:!1,middle:!1,right:!1},document.body.addEventListener("contextmenu",(t=>{t.preventDefault()})),document.body.addEventListener("mousedown",(t=>{0===t.button?this.mouse.left=!0:1===t.button?this.mouse.middle=!0:2===t.button&&(this.mouse.right=!0)})),document.body.addEventListener("mouseup",(t=>{0===t.button?this.mouse.left=!1:1===t.button?this.mouse.middle=!1:2===t.button&&(this.mouse.right=!1)})),document.body.addEventListener("mousemove",(t=>{this.mouse.x=t.clientX,this.mouse.y=t.clientY})),document.body.addEventListener("keydown",(t=>{t.getModifierState("CapsLock")?this.keys[t.key.toLowerCase()]=!0:this.keys[t.key]=!0})),document.body.addEventListener("keyup",(t=>{t.getModifierState("CapsLock")?this.keys[t.key.toLowerCase()]=!1:this.keys[t.key]=!1}))}}function r(t,e){let s=Math.abs(t.x-e.x),i=Math.abs(t.y-e.y);return Math.sqrt(s*s+i*i)}function l(t,e){if(t.length>0)for(let s=0;s<t.length;s++)x(t[s],e)||e.push(t[s])}function a(t){let e=t;return e.sort(((t,e)=>t.t>e.t?1:t.t<e.t?-1:void 0)),e}function c(t){let e=[],s=t.length;for(let i=0;i<s;i++)e.push([{x:t[i%s].x,y:t[i%s].y},{x:t[(i+1)%s].x,y:t[(i+1)%s].y}]);return e}function u(t,e){let s=t[0].x,i=t[1].x,n=e[0].x,o=e[1].x,h=t[0].y,r=t[1].y,l=e[0].y,a=e[1].y,c=(o-n)*(h-l)-(a-l)*(s-n),u=(a-l)*(i-s)-(o-n)*(r-h),y=c/u,x=((i-s)*(h-l)-(r-h)*(s-n))/u,f=[];if(0===u&&0!==c||y<=0||y>=1||x<0||x>1)return f;if(0===c&&0===u){for(let n=0;n<2;n++){let o=d(e[n],t);if("ORIGIN"==o.loc||"DESTINATION"==o.loc)f.push({x:e[n].x,y:e[n].y,t:o.t});else if("BETWEEN"==o.loc){let t=+(s+o.t*(i-s)).toFixed(9),e=+(h+o.t*(r-h)).toFixed(9);f.push({x:t,y:e,t:o.t})}}return f}{for(let s=0;s<2;s++){let i=d(e[s],t);"ORIGIN"!=i.loc&&"DESTINATION"!=i.loc||f.push({x:e[s].x,y:e[s].y,t:i.t})}if(f.length>0)return f;let n=+(s+y*(i-s)).toFixed(9),o=+(h+y*(r-h)).toFixed(9);return f.push({x:n,y:o,t:y}),f}}function d(t,e){let s=e[1].x-e[0].x,i=e[1].y-e[0].y,n=t.x-e[0].x,o=t.y-e[0].y,h=s*o-n*i;if(t.x===e[0].x&&t.y===e[0].y)return{loc:"ORIGIN",t:0};if(t.x===e[1].x&&t.y===e[1].y)return{loc:"DESTINATION",t:1};let r,l=(y([e[1],e[0]])-y([{x:e[1].x,y:e[1].y},{x:t.x,y:t.y}]))%360;return l<0&&(l+=360),h<-1e-9?{loc:"LEFT",theta:l}:h>1e-9?{loc:"RIGHT",theta:l}:s*n<0||i*o<0?{loc:"BEHIND",theta:l}:Math.sqrt(s*s+i*i)<Math.sqrt(n*n+o*o)?{loc:"BEYOND",theta:l}:(r=0!==s?n/s:o/i,{loc:"BETWEEN",t:r})}function y(t){let e=t[1].x-t[0].x,s=t[1].y-t[0].y;if(0===e&&0===s)return!1;if(0===e)return s>0?90:270;if(0===s)return e>0?0:180;let i=360*Math.atan(s/e)/(2*Math.PI);return e>0?s>=0?i:i+360:i+180}function x(t,e){if(0===e.length)return!1;for(let s=0;s<e.length;s++)if(t.x===e[s].x&&t.y===e[s].y)return!0;return!1}function f(t,e){if(0===e.length)return!1;for(let s=0;s<e.length;s++)if(p(t,e[s]))return!0;return!1}function p(t,e){return t[0].x===e[0].x&&t[0].y===e[0].y&&t[1].x===e[1].x&&t[1].y===e[1].y||t[0].x===e[1].x&&t[0].y===e[1].y&&t[1].x===e[0].x&&t[1].y===e[0].y}function g(t,e){if(0===e.length)return!1;for(let s=0;s<e.length;s++)if(t.length===e[s].length)for(let i=0;i<t.length&&x(t[i],e[s]);i++)if(i===t.length-1)return!0;return!1}function m(t){let e=t.length,s=0;for(let i=0;i<e;i++)s+=Math.abs(t[i%e].x*t[(i+1)%e].y-t[i%e].y*t[(i+1)%e].x);return s/2}function w(t){let e,s,i=function(t){let e={x:{min:t[0].x,max:t[0].x},y:{min:t[0].y,max:t[0].y}};for(let s=1;s<t.length;s++)t[s].x<e.x.min&&(e.x.min=t[s].x),t[s].x>e.x.max&&(e.x.max=t[s].x),t[s].y<e.y.min&&(e.y.min=t[s].y),t[s].y>e.y.max&&(e.y.max=t[s].y);return e}(t),n=c(t),o=i.y.min+(i.y.max-i.y.min)/Math.PI,h=(i.y.max-i.y.min)/13,r=[],l=[],d=!1;for(;!d;){r=[{x:i.x.min-1,y:o},{x:i.x.max+1,y:o}];for(let t=0;t<n.length;t++)s=u(r,n[t]),s&&1===s.length&&l.push(s[0]);l=a(l);for(let t=0;t<l.length-1;t++)l[t].t!==l[t+1].t&&(d=!0,e={x:(l[t].x+l[t+1].x)/2,y:o});o+=h,(o>i.y.max||o<i.y.min)&&!1===d&&(d=!0,e=void 0)}return e}function v(t,e){let s,i,n,o=0,h=c(e);for(let e=0;e<h.length;e++)if([i,n]=h[e],s=d(t,[i,n]),("RIGHT"===s.loc&&i.y<t.y&&n.y>=t.y||"LEFT"===s.loc&&i.y>=t.y&&n.y<t.y)&&o++,"BETWEEN"===s.loc)return!1;return!!(o%2)}let b=0;function M(){return b++}const B={};class A extends n{constructor(t){super("Physics",t),this.bodies=[],this.friction=.8}update(){for(let t=0;t<this.bodies.length;t++){const e=this.bodies[t];for(let s=t+1;s<this.bodies.length;s++){const t=this.bodies[s],i=e.collides[t.uuid];if(i)if(e instanceof B.Group)if(t instanceof B.Group)for(const s of e.bodies)for(const e of t.bodies)B.collisionUpdate(s,e,i);else for(const s of e.bodies)B.collisionUpdate(s,t,i);else B.collisionUpdate(e,t,i)}}}render(){if(this.options.drawBodies)for(const t of this.bodies)if(t instanceof B.Group)for(const e of t.bodies)i(this.scene,e);else i(this.scene,t)}Detector([t,e],s){let i=t instanceof B.Group&&t||t.getBody(),n=e instanceof B.Group&&e||e.getBody();-1==this.bodies.indexOf(i)&&this.bodies.push(i),-1==this.bodies.indexOf(n)&&this.bodies.push(n),i.collides[n.uuid]={body:n,cb:s},n.collides[i.uuid]={body:i,cb:s}}}B.Body=class{constructor(t=[]){this.uuid=M(),this.rvecs=t,this.vecs=t,this.angle=0,this.velocity=new e,this.collides={}}update(){if(this.owner instanceof I){let t=this.AABB(),s=t[0],i=t[2],n=(s.x+i.x)/2,o=(s.y+i.y)/2;this.rotateTo(this.owner.angle,new e(n,o))}this.velocity.x*=this.manager.friction,this.velocity.y*=this.manager.friction,Math.abs(this.velocity.x)<.1&&(this.velocity.x=0),Math.abs(this.velocity.y)<.1&&(this.velocity.y=0);for(let t=0;t<this.vecs.length;t++){const e=this.vecs[t];e.x+=this.velocity.x,e.y+=this.velocity.y}}rotate(t=new Angle,s=new e){for(let e=0;e<this.vecs.length;e++)this.vecs[e].rotate(t,s)}rotateTo(t=new Angle,s=new e){t-this.angle!=Number.EPSILON&&(this.rotate(t-this.angle,s),this.angle=t)}remove(){this.parent&&this.parent.bodies.splice(this.parent.bodies.indexOf(this),1)}moveTo(t){t instanceof T&&(t=e.sum(t.position,new e(-t.anchor.x*t.width,-t.anchor.y*t.height)));let s=[];for(let i=0;i<this.rvecs.length;i++){const n=this.rvecs[i];s[i]=e.sum(n,t)}this.vecs=s}getOffset(){let t=1/0,e=1/0,s=-1/0,i=-1/0;for(const n of this.vecs)n.x<t&&(t=n.x),n.y<e&&(e=n.y),n.x>s&&(s=n.x),n.y>i&&(i=n.y);const n=s-t,o=i-e;return n<o?{key:"x",value:n}:{key:"y",value:o}}AABB(){let t=1/0,s=1/0,i=-1/0,n=-1/0;for(const e of this.vecs)e.x<t&&(t=e.x),e.y<s&&(s=e.y),e.x>i&&(i=e.x),e.y>n&&(n=e.y);return[new e(t,s),new e(i,s),new e(i,n),new e(t,n)]}},B.Body.Square=class extends B.Body{constructor(t){super([new e(0,0),new e(t,0),new e(t,t),new e(0,t)])}},B.collides=(t,e)=>function(t,e){for(let e=0;e<t.length;e++)t[e].x=+t[e].x.toFixed(9),t[e].y=+t[e].y.toFixed(9);for(let t=0;t<e.length;t++)e[t].x=+e[t].x.toFixed(9),e[t].y=+e[t].y.toFixed(9);let s=function(t,e){for(let s=0;s<t.length;s++)for(let i=0;i<e.length;i++)r(t[s],e[i])<1e-8&&(t[s]=e[i]);return t}(e,t);if(!function(t,e){let s=[t,e];for(let t=0;t<s.length;t++)if(s[t].length<3)return console.error("Polygon "+(t+1)+" is invalid!"),!1;return!0}(t,s))return!1;let i=function(t,e){let s=c(t).concat(c(e)),i=[];for(let t=0;t<s.length;t++){let e=[];for(let i=0;i<s.length;i++)t!=i&&l(u(s[t],s[i]),e);let n=s[t][0];n.t=0;let o=s[t][1];o.t=1,l([n,o],e),e=a(e);for(let t=0;t<e.length-1;t++){let s=[{x:e[t].x,y:e[t].y},{x:e[t+1].x,y:e[t+1].y}];f(s,i)||i.push(s)}}return i}(t,s),n=function(t){let e=[],s=[],i=t.length,n=function(t){let e,s,i=[];for(let n=0;n<t.length;n++)e=(t[n][0].x+t[n][1].x)/2,s=(t[n][0].y+t[n][1].y)/2,"BETWEEN"!=d({x:e,y:s},t[n]).loc&&console.error("Midpoint calculation error"),i.push({x:e,y:s});return i}(t);for(let o=0;o<i-2;o++){let h,r,l,a,c={x:t[o][0].x,y:t[o][0].y},u={x:t[o][1].x,y:t[o][1].y},y=o;for(l=0;l<2;l++){for(s=[],a=!1;0===s.length||!a;){s.push({x:c.x,y:c.y}),h=void 0;for(let e=0;e<i;e++)if(r=void 0,!p(t[e],t[y])&&(t[e][0].x===u.x&&t[e][0].y===u.y&&(r=t[e][1]),t[e][1].x===u.x&&t[e][1].y===u.y&&(r=t[e][0]),r)){let t=d(r,[c,u]);(!h||t.theta<h.theta&&0===l||t.theta>h.theta&&1===l)&&(h={x:r.x,y:r.y,theta:t.theta,edge:e})}if(c.x=u.x,c.y=u.y,u.x=h.x,u.y=h.y,y=h.edge,p([c,u],t[o])){a=!0;for(let t=0;t<n.length;t++)v(n[t],s)&&(s=!1)}}s&&!g(s,e)&&e.push(s)}}return e}(i),o=function(t,e,s,i){let n,o,h,r=[],l=function(t,e){let s=[];for(let e=0;e<t.length;e++)m(t[e])>=1e-4&&s.push(t[e]);return s}(t);for(let t=0;t<l.length;t++)h=w(l[t]),n=v(h,e),o=v(h,s),n&&o&&r.push(l[t]);return r}(n,t,s);return o}(t.vecs,e.vecs),B.AABBcollides=(t,e)=>{let s=t.AABB(),i=e.AABB();return s[0].x<i[2].x&&s[2].x>i[0].x&&s[0].y<i[2].y&&s[2].y>i[0].y},B.collisionUpdate=(t,e,s)=>{if(B.AABBcollides(t,e)){let i=B.collides(t,e);i.length>0&&s.cb(i,t,e)}},B.Group=class{constructor(){this.uuid=M(),this.collides={},this.bodies=[]}add(t){t.parent=this,this.bodies.push(t)}};class T extends class extends class{constructor(t,s=new e){this.scene=t,this.scene.objects.push(this),this.position=s}remove(){this.scene.objects.splice(this.scene.objects.indexOf(this),1)}render(){}}{constructor(t,s,i=new e){super(t,i),this.key=s,this.asset=t.Modules.AssetLoader.getAsset(s),this.anchor=new e(0,0),this.width=this.asset.image.width,this.height=this.asset.image.height}cull(){return this.position.x+this.width<0||this.position.x>this.scene.canvas.width||this.position.y+this.height<0||this.position.y>this.scene.canvas.height}update(){}render(){this.angle?(this.scene.ctx.save(),this.scene.ctx.translate(this.position.x,this.position.y),this.scene.ctx.rotate(this.angle),this.scene.ctx.drawImage(this.asset.image,-this.anchor.x*this.width,-this.anchor.y*this.height),this.scene.ctx.restore()):this.scene.ctx.drawImage(this.asset.image,this.position.x-this.anchor.x*this.width,this.position.y-this.anchor.y*this.height)}}{constructor(t,s,i=new e){super(t,s,i),this.body=new B.Body.Square(this.asset.image.width),this.body.manager=t.Modules.Physics,this.body.parent=t.Modules.Physics,this.body.owner=this,this.body.moveTo(i)}remove(){this.body.remove(),super.remove()}getBody(){return this.body}collides(){}update(){this.body.update();let t=this.body.AABB()[0];this.position.x=t.x+this.anchor.x*this.width,this.position.y=t.y+this.anchor.y*this.height}render(){let t=this.body.AABB()[0];this.position.x=t.x+this.anchor.x*this.width,this.position.y=t.y+this.anchor.y*this.height,super.render()}}class I extends T{constructor(t,s=new e,i=0){super(t,"player",s),this.angle=i,this.speed=10,this.anchor={x:.5,y:.5},this.distance=0,this.lifeSpan=500}update(){let t=Math.cos(this.angle)*this.speed,s=Math.sin(this.angle)*this.speed;this.body.velocity=new e(t,s),this.distance+=Math.sqrt(t*t+s*s),this.distance>this.lifeSpan&&this.remove(),super.update()}render(){super.render()}}class E extends T{constructor(t,s=new e){super(t,"player",s),this.anchor=new e(.5,.5),this.fireRate=100,this.lastFire=0,this.velocity=.6,this.bulletsPhysicsGroup=new B.Group}move(t=new e){let s=this.getBody();s.velocity=e.sum(s.velocity,t)}update(){if(super.update(),this.scene.Modules.InputHandler&&(this.scene.Modules.InputHandler.keys.w&&this.move(new e(0,-this.velocity)),this.scene.Modules.InputHandler.keys.s&&this.move(new e(0,this.velocity)),this.scene.Modules.InputHandler.keys.a&&this.move(new e(-this.velocity,0)),this.scene.Modules.InputHandler.keys.d&&this.move(new e(this.velocity,0)),this.scene.Modules.InputHandler.mouse.left&&Date.now()-this.lastFire>this.fireRate)){let t=this.position.clone();t.x-=this.anchor.x*this.width,t.y-=this.anchor.y*this.height;let s=new I(this.scene,t,this.position.angleBetween(new e(this.scene.Modules.InputHandler.mouse.x,this.scene.Modules.InputHandler.mouse.y)));this.bulletsPhysicsGroup.add(s.getBody()),this.lastFire=Date.now()}}}class k{constructor(){this.tiles=[],this.group=new B.Group,this.spawn=new e}loadToScene(t){this.spawn.x=16*Math.floor(Math.random()*t.canvas.width/16),this.spawn.y=16*Math.floor(Math.random()*t.canvas.height/16);for(let s=0;s<t.canvas.width/16;s++)for(let i=0;i<t.canvas.height/16;i++)if(s!=this.spawn.x&&i!=this.spawn.y&&Math.random()>.99){let n=new T(t,"player",new e(16*s,16*i));this.group.add(n.getBody()),this.tiles.push(n)}}}document.addEventListener("DOMContentLoaded",(async()=>{let t=new s({backgroundColor:"rgba(33, 33, 33, 1)"});const i=t.useModule(new o);t.useModule(new h);const n=t.useModule(new A({drawBodies:!0}));i.loadSprite("player","assets/player.png",16,16),await i.loaded();let r=new k;r.loadToScene(t),console.log(r.spawn);let l=new E(t,r.spawn);for(const e of t.objects)e.cull();n.Detector([r.group,l],((t,s,i)=>{let n,o,h=new B.Body(t[0]).getOffset();l.body.uuid===s.uuid&&(n=s,o=i),l.body.uuid===i.uuid&&(n=i,o=s);let r={x:Math.sign(n.AABB()[0].x-o.AABB()[0].x),y:Math.sign(n.AABB()[0].y-o.AABB()[0].y)},a=new e;a[h.key]=h.value*r[h.key],n.moveTo(e.sum(n.AABB()[0],a))})),n.Detector([l.bulletsPhysicsGroup,r.group],((t,e,s)=>{let i,n;e.parent==l.bulletsPhysicsGroup&&(i=e,n=s),s.parent==l.bulletsPhysicsGroup&&(i=s,n=e),i.owner.remove()})),t.update=()=>{}}))})();